I"Ô]<ul id="markdown-toc">
  <li><a href="#æ–‡ç« é“¾æ¥" id="markdown-toc-æ–‡ç« é“¾æ¥">æ–‡ç« é“¾æ¥</a></li>
  <li><a href="#æ¨¡å‹åŸç†" id="markdown-toc-æ¨¡å‹åŸç†">æ¨¡å‹åŸç†</a></li>
  <li><a href="#æ¨¡å‹å®‰è£…" id="markdown-toc-æ¨¡å‹å®‰è£…">æ¨¡å‹å®‰è£…</a></li>
  <li><a href="#æ¨¡å‹å®ç°" id="markdown-toc-æ¨¡å‹å®ç°">æ¨¡å‹å®ç°</a>    <ul>
      <li><a href="#å…³é”®å‚æ•°" id="markdown-toc-å…³é”®å‚æ•°">å…³é”®å‚æ•°</a></li>
    </ul>
  </li>
</ul>

<h2 id="æ–‡ç« é“¾æ¥">æ–‡ç« é“¾æ¥</h2>

<p><a href="https://xkw168.github.io/2019/05/20/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%A2%84%E6%B5%8B-%E4%B8%80-%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86/">ï¼ˆä¸€ï¼‰æ•°æ®é¢„å¤„ç†</a></p>

<p><a href="https://xkw168.github.io/2019/05/20/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%A2%84%E6%B5%8B-%E4%BA%8C-AR%E6%A8%A1%E5%9E%8B/">ï¼ˆäºŒï¼‰ARæ¨¡å‹ï¼ˆè‡ªå›å½’æ¨¡å‹ï¼‰</a></p>

<p><a href="https://xkw168.github.io/2019/05/20/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%A2%84%E6%B5%8B-%E4%B8%89-Xgboost%E6%A8%A1%E5%9E%8B/">ï¼ˆä¸‰ï¼‰Xgboostæ¨¡å‹</a></p>

<p><a href="https://xkw168.github.io/2019/05/20/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%A2%84%E6%B5%8B-%E5%9B%9B-LSTM%E6%A8%A1%E5%9E%8B/">ï¼ˆå››ï¼‰LSTMæ¨¡å‹</a></p>

<p><a href="https://xkw168.github.io/2019/05/20/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%A2%84%E6%B5%8B-%E4%BA%94-Prophet%E6%A8%A1%E5%9E%8B/">ï¼ˆäº”ï¼‰Prophetæ¨¡å‹ï¼ˆè‡ªå›å½’æ¨¡å‹ï¼‰</a></p>

<hr />

<h2 id="æ¨¡å‹åŸç†">æ¨¡å‹åŸç†</h2>

<p>â€ƒâ€ƒLSTMï¼ˆLong-short time memoryï¼ŒLSTMï¼‰æ¨¡å‹ï¼Œäº¦å³æ˜¯é•¿æ®µæ—¶é—´æ¨¡å‹ã€‚LSTMçš„åŸç†è¿™ç¯‡<a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">åšå®¢</a>è®²çš„ååˆ†çš„æ¸…æ¥šï¼Œå»ºè®®è‹±è¯­å¥½çš„å°ä¼™ä¼´ç›´æ¥å»çœ‹åŸæ–‡ï¼Œæˆ‘è¿™é‡Œå°±å¤§è‡´çš„ç¿»è¯‘ç²¾ç®€ä¸€ä¸‹ã€‚<br />
â€ƒâ€ƒäººç±»å¤©ç”Ÿå…·å¤‡çš„ä¸€ä¸ªèƒ½åŠ›å°±æ˜¯è®°å¿†çš„æŒä¹…æ€§ï¼Œå¯ä»¥æ ¹æ®è¿‡å¾€ç»éªŒï¼Œä»è€Œæ¨æ–­å‡ºå½“å‰çœ‹åˆ°çš„å†…å®¹çš„å®é™…å«ä¹‰ã€‚å¦‚çœ‹ç”µå½±çš„æ—¶å€™å¯ä»¥é€šè¿‡å…ˆå‰æ—¶é—´å»æ¨æ–­åç»­äº‹ä»¶ï¼›çœ‹ä¸€ç¯‡æ–‡ç« çš„æ—¶å€™ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡è¿‡å¾€çš„çŸ¥è¯†ç§¯ç´¯å»æ¨æ–­æ–‡ç« ä¸­æ¯ä¸ªè¯è¯­çš„å«ä¹‰ã€‚è€Œä¼ ç»Ÿçš„ç¥ç»ç½‘ç»œå¹¶æ²¡æœ‰â€œæŒä¹…æ€§â€ï¼Œæ¯ä¸€ä¸ªç¥ç»å…ƒä¸èƒ½é€šè¿‡å‰é¢ç¥ç»å…ƒçš„ç»“æœè¿›è¡Œæ¨æ–­ï¼Œä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ç§‘å­¦å®¶æå‡ºäº†é€’å½’ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networksï¼ŒRNNï¼‰ã€‚RNNæ˜¯åŒ…å«å¾ªç¯çš„ç¥ç»ç½‘ç»œï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰ï¼Œå…è®¸ä¿¡æ¯çš„æŒä¹…åŒ–ã€‚å…¶ä¸­Aå¯ä»¥çœ‹ä½œç¥ç»ç½‘ç»œçš„ä¸€ä¸ªç¼©å½±ï¼Œæ¥å—æŸæ—¶åˆ»çš„è¾“å…¥\(X_t\)ç„¶åè¾“å‡ºå¯¹åº”çš„ç»“æœ$h_t$ï¼Œä¸€ä¸ªå›è·¯å¯ä»¥å…è®¸ä¿¡æ¯ä»ä¸€æ­¥ä¼ é€’åˆ°å¦ä¸€æ­¥ã€‚</p>

<p><img src="/img/rnn.png" alt="RNNç¤ºæ„å›¾" /></p>

<p>â€ƒâ€ƒä¸ºäº†æ›´ç›´è§‚çš„å±•ç¤ºï¼Œå°†å›è·¯æ‹†åˆ†å¼€æ¥ï¼Œç”¨ä¸€ä¸ªè¿ç»­çš„åºåˆ—è¿›è¡Œè¡¨ç¤ºï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰ã€‚ä¸€ä¸ªå¾ªç¯ç¥ç»ç½‘ç»œå¯ä»¥çœ‹ä½œæ˜¯è‹¥å¹²ä¸ªç›¸åŒçš„åŸºæœ¬å•å…ƒè¿æ¥èµ·æ¥ï¼Œæ¯ä¸€ä¸ªåŸºæœ¬å•å…ƒéƒ½å¯ä»¥å°†ä¿¡æ¯ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªåŸºæœ¬å•å…ƒã€‚
<img src="/img/rnn_split.png" alt="RNNåˆ†è§£ç¤ºæ„å›¾" /></p>

<p>â€ƒâ€ƒå¸¸è§„çš„RNNå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ— æ³•è§£å†³â€œé•¿æœŸä¾èµ–â€ï¼ˆlong-term dependencyï¼‰é—®é¢˜ï¼Œå³æœ‰ç”¨ä¿¡æ¯å’Œé¢„æµ‹ç‚¹ç›¸éš”è¾ƒè¿œã€‚ä»¥è¯è¯­é¢„æµ‹ä¸ºä¾‹ï¼Œâ€œæˆ‘æ¥è‡ªä¸­å›½ï¼Œæˆ‘ä¼šè®²ä¸­æ–‡â€ï¼Œè¿™å¥è¯é‡Œé¢æœ‰ç”¨ä¿¡æ¯ä¸é¢„æµ‹ç‚¹ç›¸éš”è¾ƒè¿‘ï¼ŒRNNå¯ä»¥å¾ˆè½»æ˜“çš„æ¨æ–­å‡ºä¸‹ä¸€ä¸ªè¯è¯­åº”è¯¥æ˜¯ä¸­æ–‡ï¼Œä½†å‡å¦‚æœ‰ç”¨ä¿¡æ¯ä¸é¢„æµ‹ç‚¹ç›¸éš”è¾ƒè¿œï¼Œå¦‚â€œæˆ‘æ¥è‡ªä¸­å›½â€¦â€¦æˆ‘ä¼šè®²ä¸­æ–‡â€ï¼Œæ­¤æ—¶RNNä¾¿æ— æ³•æ¨æ–­å‡ºæ¥ä¸‹æ¥çš„è¯è¯­ã€‚æ¢å¥è¯è¯´ï¼ŒRNNçš„ä¿¡æ¯æŒä¹…æ€§ä¸å¤Ÿé«˜ï¼Œä¸èƒ½ä¿æŒå‡ åç”šè‡³ä¸Šç™¾æ­¥ã€‚<br />
â€ƒâ€ƒä¸ºäº†å¼¥è¡¥ä¼ ç»ŸRNNçš„è¿™ä¸ªç¼ºç‚¹ï¼Œäººä»¬å¼•å…¥äº†LSTMï¼ˆlong short-term memoryï¼‰è¿™ä¸ªæ¨¡å‹ã€‚LSTMå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§ç‰¹æ®Šçš„RNNï¼Œç›¸è¾ƒäºä¼ ç»ŸRNNï¼ŒLSTMå¤©ç”Ÿå°±å¯¹é•¿æœŸä¾èµ–æœ‰ç€å¾ˆå¥½çš„æ”¯æŒã€‚LSTMæ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸ºè®°å¿†å…ƒç»„ï¼ˆmemory cellï¼‰å’Œéçº¿æ€§çš„é—¨å•å…ƒï¼ˆnonlinear gating unitï¼‰ï¼Œå…¶ä¸­è®°å¿†å…ƒç»„ç”¨äºä¿æŒç³»ç»Ÿçš„çŠ¶æ€ï¼Œéçº¿æ€§çš„é—¨å•å…ƒç”¨äºåœ¨æ¯ä¸€ä¸ªæ—¶é—´ç‚¹è°ƒèŠ‚æµå…¥å’Œæµå‡ºè®°å¿†å…ƒç»„çš„ä¿¡æ¯ã€‚æ¯ä¸ªé€’å½’çš„ç¥ç»ç½‘ç»œéƒ½å¯ä»¥åˆ†è§£æˆæ— æ•°ä¸ªåŸºæœ¬é‡å¤å•å…ƒï¼Œä¼ ç»Ÿçš„RNNæ˜¯è¿™æ ·ï¼ŒLSTMä¹Ÿæ˜¯å¦‚æ­¤ã€‚åœ¨ä¼ ç»Ÿçš„RNNé‡Œé¢ï¼ŒåŸºæœ¬é‡å¤å•å…ƒå†…éƒ¨ç»“æ„ååˆ†ç®€å•ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œå±‚ï¼ˆé€šå¸¸ä¸ºä¸€ä¸ªtanhæ¨¡å—ï¼Œå¦‚å›¾æ‰€ç¤ºï¼‰ï¼›åœ¨LSTMä¸­ï¼Œä½¿ç”¨äº†å››ä¸ªç¥ç»ç½‘ç»œå±‚å¹¶ä¸”å½¼æ­¤ä¹‹é—´ä»¥ä¸€ç§ç‰¹æ®Šçš„å…³ç³»è¿›è¡Œäº¤äº’ï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰ã€‚
<img src="/img/rnn_cell.png" alt="RNNåŸºæœ¬å•å…ƒ" />
<img src="/img/lstm_cell.png" alt="LSTMåŸºæœ¬å•å…ƒ" /></p>

<hr />

<h2 id="æ¨¡å‹å®‰è£…">æ¨¡å‹å®‰è£…</h2>

<p><code class="language-plaintext highlighter-rouge">pip install tensorflow</code></p>

<hr />

<h2 id="æ¨¡å‹å®ç°">æ¨¡å‹å®ç°</h2>

<p>â€ƒâ€ƒè¿™é‡ŒåŒæ ·ä½¿ç”¨çš„æ˜¯TensorFlowé‡Œé¢çš„Timeseriesæ¨¡å—å®ç°ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%m_%d_%H_%M_%s"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_result_tf</span><span class="p">(</span><span class="n">tf_data</span><span class="p">):</span>
    <span class="s">"""
    parse the result of model output in tensorflow
    :param tf_data: the output of tensorflow
    :return: data in DataFrame format
    """</span>
    <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s">"ds"</span><span class="p">:</span> <span class="n">tf_data</span><span class="p">[</span><span class="s">"times"</span><span class="p">].</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s">"y"</span><span class="p">:</span> <span class="n">tf_data</span><span class="p">[</span><span class="s">"mean"</span><span class="p">].</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)})</span>


<span class="k">def</span> <span class="nf">generate_time_series</span><span class="p">(</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2006</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">cnt</span><span class="o">=</span><span class="mi">4018</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">False</span>
<span class="p">):</span>
    <span class="s">"""
    generate a time series/index
    :param start_date: start date
    :param cnt: date count. If =cnt are specified, delta must not be; one is required
    :param delta: time delta, default is one day.
    :param timestamp: output timestamp or format string
    :return: list of time string or timestamp
    """</span>

    <span class="k">def</span> <span class="nf">per_delta</span><span class="p">():</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="o">&lt;</span> <span class="n">end_date</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">curr</span>
            <span class="n">curr</span> <span class="o">+=</span> <span class="n">delta</span>

    <span class="n">end_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">cnt</span>

    <span class="n">time_series</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">per_delta</span><span class="p">():</span>
            <span class="n">time_series</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">per_delta</span><span class="p">():</span>
            <span class="n">time_series</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># print(t.strftime("%Y-%m-%d"))
</span>    <span class="k">return</span> <span class="n">time_series</span>


<span class="k">def</span> <span class="nf">LSTM_predict_tf</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">,</span> <span class="n">forecast_cnt</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s">"D"</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="s">""</span><span class="p">):</span>
    <span class="s">"""
    predict time series with LSTM model in tensorflow
    :param train_data: data use to train the model
    :param evaluation_data: data use to evaluate the model
    :param forecast_cnt: how many point needed to be predicted
    :param freq: the interval between time index
    :param model_dir: directory of pre-trained model(checkpoint, params)
    :return:
    """</span>
    <span class="n">model_directory</span> <span class="o">=</span> <span class="s">"./model/LSTM_%s"</span> <span class="o">%</span> <span class="n">now</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"batch_size"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">"window_size"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="c1"># The number of units in the model's LSTMCell.
</span>        <span class="s">"num_units"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="c1"># The dimensionality of the time series (one for univariate, more than one for multivariate)
</span>        <span class="s">"num_features"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="c1"># how many steps we train the model
</span>        <span class="s">"global_steps"</span><span class="p">:</span> <span class="mi">3000</span>
    <span class="p">}</span>
    <span class="c1"># if there is a pre-trained model, use parameters from it
</span>    <span class="k">if</span> <span class="n">model_dir</span><span class="p">:</span>
        <span class="n">model_directory</span> <span class="o">=</span> <span class="n">model_dir</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">read_model_param</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">+</span> <span class="s">"/params.txt"</span><span class="p">)</span>

    <span class="c1"># create time index for model training(use int)
</span>    <span class="n">time_int</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">))</span>

    <span class="n">data_train</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">TrainEvalFeatures</span><span class="p">.</span><span class="n">TIMES</span><span class="p">:</span> <span class="n">time_int</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)],</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">TrainEvalFeatures</span><span class="p">.</span><span class="n">VALUES</span><span class="p">:</span> <span class="n">train_data</span><span class="p">[</span><span class="s">"y"</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">data_eval</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">TrainEvalFeatures</span><span class="p">.</span><span class="n">TIMES</span><span class="p">:</span> <span class="n">time_int</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">):],</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">TrainEvalFeatures</span><span class="p">.</span><span class="n">VALUES</span><span class="p">:</span> <span class="n">evaluation_data</span><span class="p">[</span><span class="s">"y"</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">reader_train</span> <span class="o">=</span> <span class="n">NumpyReader</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
    <span class="n">reader_eval</span> <span class="o">=</span> <span class="n">NumpyReader</span><span class="p">(</span><span class="n">data_eval</span><span class="p">)</span>

    <span class="s">"""
    define in tensorflow/contrib/timeseries/python/timeseries/input_pipeline.py
    """</span>
    <span class="n">train_input_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">RandomWindowInputFn</span><span class="p">(</span>
        <span class="n">reader_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s">"batch_size"</span><span class="p">],</span> <span class="n">window_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s">"window_size"</span><span class="p">])</span>

    <span class="s">"""
    define in tensorflow/contrib/timeseries/python/timeseries/estimators.py
    """</span>
    <span class="n">estimator_lstm</span> <span class="o">=</span> <span class="n">ts_estimators</span><span class="p">.</span><span class="n">TimeSeriesRegressor</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">_LSTMModel</span><span class="p">(</span><span class="n">num_features</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s">"num_features"</span><span class="p">],</span> <span class="n">num_units</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s">"num_units"</span><span class="p">]),</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
        <span class="n">model_dir</span><span class="o">=</span><span class="n">model_directory</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_dir</span><span class="p">:</span>
        <span class="s">"""
        website: https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator#train
        """</span>
        <span class="n">estimator_lstm</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s">"global_steps"</span><span class="p">])</span>

    <span class="n">evaluation_input_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">WholeDatasetInputFn</span><span class="p">(</span><span class="n">reader_eval</span><span class="p">)</span>
    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">estimator_lstm</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">evaluation_input_fn</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Predict starting after the evaluation
</span>    <span class="p">(</span><span class="n">predictions</span><span class="p">,)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">estimator_lstm</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">input_fn</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">contrib</span><span class="p">.</span><span class="n">timeseries</span><span class="p">.</span><span class="n">predict_continuation_input_fn</span><span class="p">(</span>
            <span class="n">evaluation</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">forecast_cnt</span><span class="p">)))</span>

    <span class="n">save_model_param</span><span class="p">(</span><span class="n">model_directory</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">"loss"</span> <span class="ow">in</span> <span class="n">evaluation</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"loss:%.5f"</span> <span class="o">%</span> <span class="n">evaluation</span><span class="p">[</span><span class="s">"loss"</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_directory</span> <span class="o">+</span> <span class="s">"/%s"</span> <span class="o">%</span> <span class="n">evaluation</span><span class="p">[</span><span class="s">"loss"</span><span class="p">],</span> <span class="s">"w"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">model_log</span><span class="p">(</span>
            <span class="n">evaluation</span><span class="p">[</span><span class="s">"loss"</span><span class="p">],</span>
            <span class="n">average_loss</span><span class="o">=-</span><span class="mi">1</span> <span class="k">if</span> <span class="s">"average_loss"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation</span><span class="p">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">evaluation</span><span class="p">[</span><span class="s">"average_loss"</span><span class="p">],</span>
            <span class="n">content</span><span class="o">=</span><span class="n">model_dir</span>
        <span class="p">)</span>

    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">parse_result_tf</span><span class="p">(</span><span class="n">evaluation</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">parse_result_tf</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
    <span class="n">first_date</span> <span class="o">=</span> <span class="n">evaluation_data</span><span class="p">[</span><span class="s">"ds"</span><span class="p">].</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evaluation</span><span class="p">[</span><span class="s">"ds"</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="n">first_date</span><span class="p">,</span> <span class="n">cnt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">evaluation</span><span class="p">),</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta_dict</span><span class="p">[</span><span class="n">freq</span><span class="p">])</span>
    <span class="n">latest_date</span> <span class="o">=</span> <span class="n">evaluation_data</span><span class="p">[</span><span class="s">"ds"</span><span class="p">].</span><span class="n">tolist</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">predictions</span><span class="p">[</span><span class="s">"ds"</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_time_series</span><span class="p">(</span><span class="n">latest_date</span><span class="p">,</span> <span class="n">cnt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta_dict</span><span class="p">[</span><span class="n">freq</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">predictions</span>
</code></pre></div></div>

<hr />

<h3 id="å…³é”®å‚æ•°">å…³é”®å‚æ•°</h3>

<ul>
  <li>window_sizeï¼šâ€œè§‚å¯Ÿçª—â€å¤§å°ï¼Œç”¨äºæ§åˆ¶å°†å¤šå°‘ä¸ªè¿ç»­çš„æ—¶é—´åºåˆ—æ”¾åœ¨ä¸€èµ·ï¼›</li>
  <li>batch_sizeï¼šæ‰¹æ¬¡å¤§å°ï¼Œç”¨äºæ§åˆ¶å°†å¤šå°‘ä¸ªâ€œè§‚å¯Ÿçª—â€ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œæ¨¡å‹è®­ç»ƒçš„æ—¶å€™æ¢¯åº¦å°±ä¼šè¶Šç¨³å®šï¼›</li>
  <li>num_featuresï¼šä¸ARæ¨¡å‹ä¸€è‡´ï¼Œæ˜¯æ—¶é—´åºåˆ—çš„ç»´åº¦ï¼›</li>
  <li>num_unitsï¼šæ¯ä¸ªLSTMå…ƒç»„ï¼ˆcellï¼‰é‡Œé¢åŒ…å«å¤šå°‘ä¸ªåŸºæœ¬å•å…ƒï¼ˆunitï¼‰ï¼›</li>
  <li>optimizerï¼šä¼˜åŒ–å™¨çš„ç§ç±»ï¼›</li>
  <li>learning_rateï¼šå­¦ä¹ é€Ÿç‡ï¼Œä¸æ¨¡å‹è®­ç»ƒæ—¶é—´æˆè´Ÿç›¸å…³ï¼Œå­¦ä¹ ç‡è¶Šå¤§è®­ç»ƒæ—¶é—´è¶ŠçŸ­ï¼Œä½†æ˜¯è¿‡å¤§çš„å­¦ä¹ ç‡å¯èƒ½ä¼šå¯¼è‡´æ¨¡å‹æ— æ³•æ”¶æ•›ï¼›</li>
  <li>stepsï¼šæ¨¡å‹çš„è®­ç»ƒè¿­ä»£æ¬¡æ•°ã€‚</li>
</ul>

<p>æ³¨æ„ç”±äºLSTMæ¨¡å‹è¾ƒä¸ºå¤æ‚ï¼Œæ•…å½“æ•°æ®é‡è¾ƒå°‘è€Œè§„å¾‹ä¸æ˜æ˜¾çš„æƒ…å†µä¸‹ï¼Œå…¶æ¨¡å‹è¡¨ç°å¯èƒ½ä¸å°½äººæ„ã€‚</p>
:ET